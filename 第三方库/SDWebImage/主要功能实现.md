## SDWebImage
常用的图片缓存以及图片下载库

### UIImageView+WebCache.h

UIImageView的功能入口

对外提供设置图片的相关方法
```
- (void)sd_setImageWithURL:(nullable NSURL *)url
          placeholderImage:(nullable UIImage *)placeholder
                   options:(SDWebImageOptions)options
                   context:(nullable SDWebImageContext *)context
                  progress:(nullable SDImageLoaderProgressBlock)progressBlock
                 completed:(nullable SDExternalCompletionBlock)completedBlock
```
参数说明：
  - url: 图片地址
  - placeholder: 未加载完成时使用的图片
  - options: 加载图片的设置
  - context: [SDWebImageContextOption: id] 的字典，保存了这个函数中可能会使用到的各种自定义操作
  - progressBlock: 下载中的回调
  - completedBlock: 下载完成的回调
该方法主要调用UIView+WebCache.h的方法

### UIView+WebCache.h

处理实际下载图片的逻辑，包括处理所有的回调逻辑

```
- (void)sd_internalSetImageWithURL:(nullable NSURL *)url
                  placeholderImage:(nullable UIImage *)placeholder
                           options:(SDWebImageOptions)options
                           context:(nullable SDWebImageContext *)context
                     setImageBlock:(nullable SDSetImageBlock)setImageBlock
                          progress:(nullable SDImageLoaderProgressBlock)progressBlock
                         completed:(nullable SDInternalCompletionBlock)completedBlock
```

参数说明：
- url: 图片地址
- placeholder: 未加载完成时使用的图片
- options: 加载图片的设置
- context: [SDWebImageContextOption: id] 的字典，保存了这个函数中可能会使用到的各种自定义操作
- setImageBlock: 调用设置图片的回调，可以处理设置图片时的操作，如果没有设置block值，默认为只设置图片
- progressBlock: 下载进度更新时的回调
- completedBlock: 设置图片完成的回调，在setImageBlock之后调用

具体逻辑：

1. 处理context的SDWebImageContextSetImageOperationKey，如果没有值，使用当前类名作为SDWebImageContextSetImageOperationKey。赋值sd_latestOperationKey，这个值是作为当前视图最后一次操作的key值，调用sd_cancelImageLoadOperationWithKey取消当前正在下载的任务
2. 赋值sd_imageURL
3. 判断option是否存在SDWebImageDelayPlaceholder配置，如果不存在，直接设置当前的placeholder为视图的图片
4. 判断url是否有值，若没有值，停止下载动画
5. 重置当前的下载进度sd_imageProgress
6. 开始下载动画sd_startImageIndicator
7. 处理context的SDWebImageContextCustomManager，如果没有值，使用sharedManager
8. 设置下载中的回调combinedProgressBlock，其中会包含更新下载动画和progressBlock的执行
9. 使用manager创建operation，设置成功的回调
  - 更新imageProgress
  - 更新下载动画
  - 设置callCompletedBlock作为结束的回调，其中，如果图片已下载完成或设置option包含SDWebImageAvoidAutoSetImage，会调用completedBlock
  - 如果（图片获取成功且设置option包含SDWebImageAvoidAutoSetImage）或者（图片获取失败且未设置option包含SDWebImageDelayPlaceholder），直接调用callCompletedBlock
  - 如果图片以获取成功且未设置option包含SDWebImageAvoidAutoSetImage，targetImage设置为image；如果图片获取失败且设置option包含SDWebImageDelayPlaceholder，targetImage设置为placeholder
  - 设置transition
  - 设置targetImage为当前视图的图片，调用callCompletedBlock
10. 调用sd_setImageLoadOperation将当前operation加入sd_operationDictionary

设置图片的方法

```
- (void)sd_setImage:(UIImage *)image imageData:(NSData *)imageData basedOnClassOrViaCustomSetImageBlock:(SDSetImageBlock)setImageBlock transition:(SDWebImageTransition *)transition cacheType:(SDImageCacheType)cacheType imageURL:(NSURL *)imageURL
```

参数说明：
- image: 需要设置的图片
- imageData: 图片的data
- setImageBlock: 设置图片的block
- transition: 动画效果
- cacheType: 图片的缓存类型
- imageURL: 图片URL

具体逻辑：
1. 设置finalSetImageBlock，如果setImageBlock为空，会调用当前视图对应的设置image方法
2. 如果transition不为空，调用动画逻辑并调用finalSetImageBlock，否则直接调用finalSetImageBlock

### SDWebImageManager.h

```
- (SDWebImageCombinedOperation *)loadImageWithURL:(nullable NSURL *)url
                                          options:(SDWebImageOptions)options
                                          context:(nullable SDWebImageContext *)context
                                         progress:(nullable SDImageLoaderProgressBlock)progressBlock
                                        completed:(nonnull SDInternalCompletionBlock)completedBlock
```

参数说明：
- url: 图片地址
- options: 加载图片的设置
- context: [SDWebImageContextOption: id] 的字典，保存了这个函数中可能会使用到的各种自定义操作
- progressBlock: 下载中的回调
- completedBlock: 下载完成的回调

具体逻辑：
1. 创建operation
2. 判断url长度为0或（已经下载失败且未在option设置SDWebImageRetryFailed），若满足条件，执行error逻辑
3. 将任务添加到runningOperations中
4. 初始化optionsProcessor，用于初始化下载的配置
5. 初始化imageCache
6. 判断options是否设置SDWebImageFromLoaderOnly
   - 已设置则直接进行下载逻辑callDownloadProcess
   - 未设置则查询缓存queryImage
     - operation不存在或已取消时执行completion回调，并将operation从runningOperation中移出
     - 若context的SDWebImageContextImageTransformer有值且cachedImage未找到则去查找原始图片callOriginalCacheProcess
       - 如果originalQueryCacheType不为SDImageCacheTypeNone，查询缓存queryImage
         - operation不存在或已取消时执行completion回调，并将operation从runningOperation中移出
         - 若context的SDWebImageContextImageTransformer有值且cachedImage未找到则去下载callDownloadProcess
         - 其他情况执行callStoreCacheProcess
           - 如果context中的SDWebImageContextImageTransformer有值，调用storeImage并在回调中执行callTransformProcess
           - 如果context中的SDWebImageContextImageTransformer没有值，调用transform逻辑callTransformProcess
       - 如果originalQueryCacheType为SDImageCacheTypeNone，直接进行下载逻辑callDownloadProcess
     - 其他情况直接执行下载逻辑callDownloadProcess

```
- (void)callDownloadProcessForOperation:(nonnull SDWebImageCombinedOperation *)operation
                                    url:(nonnull NSURL *)url
                                options:(SDWebImageOptions)options
                                context:(SDWebImageContext *)context
                            cachedImage:(nullable UIImage *)cachedImage
                             cachedData:(nullable NSData *)cachedData
                              cacheType:(SDImageCacheType)cacheType
                               progress:(nullable SDImageLoaderProgressBlock)progressBlock
                              completed:(nullable SDInternalCompletionBlock)completedBlock
```

参数说明：
- operation: 进行加载的操作
- url: 图片地址
- options: 加载图片的设置
- context: [SDWebImageContextOption: id] 的字典，保存了这个函数中可能会使用到的各种自定义操作
- cachedImage: 缓存中的图片
- cachedData: 缓存中的图片data
- cacheType: 缓存类型
- processBlock: 下载中的回调
- completedBlock: 下载完成的回调

具体逻辑：
1. 初始化imageLoader，校验是否下载，无需下载直接返回cachedImage
2. 使用imageLoader的requestImage方法下载图片并在回调中执行
   - 如果operation不存在或已取消，调用返回回调
   - 如果cachedImage不为空且需要刷新缓存SDWebImageRefreshCached且报错SDWebImageErrorCacheNotModified，不处理，错误原因为链接命中了NSURLCache缓存，不需要回调
   - 如果报错为SDWebImageErrorCancelled，调用返回回调，错误原因为发送请求前被取消，不需要加入失败链接failedURL
   - 其他报错需要处理返回回调和加入failedURL逻辑
   - 正常获取图片后需要调用去除failedURL逻辑，并调用callStoreProcess
     - 如果context中的SDWebImageContextImageTransformer有值，调用storeImage并在回调中执行callTransformProcess
     - 如果context中的SDWebImageContextImageTransformer没有值，调用transform逻辑callTransformProcess
   - 如果已经完成，将operation从runningOperations中移出

### SDImageCache.h

查询缓存

```
- (nullable NSOperation *)queryCacheOperationForKey:(nullable NSString *)key options:(SDImageCacheOptions)options context:(nullable SDWebImageContext *)context cacheType:(SDImageCacheType)queryCacheType done:(nullable SDImageCacheQueryCompletionBlock)doneBlock
```

参数说明：
- key: 图片对应的key
- options: 加载图片的配置
- context: [SDWebImageContextOption: id] 的字典，保存了这个函数中可能会使用到的各种自定义操作
- queryCacheType: 图片缓存类型
- doneBlock: 完成回调

具体逻辑：

1. 校验key和queryCacheType是否有值，为空直接返回
2. 如果queryCacheType不为SDImageCacheTypeDisk，直接查询内存缓存memoryCache，如果只查询内存，直接返回
3. 创建operation查询磁盘，如果内存中已查到，优先使用内存中的图片image，但是回调中使用磁盘中的data，如果需要缓存图片到内存，将图片存入内存缓存memoryCache

存入缓存

```
- (void)storeImage:(nullable UIImage *)image
         imageData:(nullable NSData *)imageData
            forKey:(nullable NSString *)key
          toMemory:(BOOL)toMemory
            toDisk:(BOOL)toDisk
        completion:(nullable SDWebImageNoParamsBlock)completionBlock
```
参数说明：
- image: 即将存入的图片
- imageData: 图片的data
- kay: 存入图片对应的key
- toMemory: 是否存入内存缓存
- toDisk: 是否存入磁盘缓存
- completion: 完成回调

具体逻辑：
1. 校验image和key是否为空，为空则直接返回
2. 如果存入内存缓存，则将image存入内存缓存memoryCache，NSMapTable
3. 如果不存入磁盘，直接返回
4. 如果未编码调用编码encodedData
5. 将data存入磁盘缓存diskCache，将data存入文件中
